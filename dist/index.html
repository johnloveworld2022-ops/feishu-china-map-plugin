<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ¦ é£ä¹¦é“¶è¡Œæœºæ„åœ°å›¾ä»ªè¡¨ç›˜</title>
    <link rel="icon" type="image/svg+xml" href="icon.svg">
    
    <!-- é£ä¹¦æ’ä»¶ SDK -->
    <script src="https://lf1-cdn-tos.bytegoofy.com/obj/static/lark/sdk/feishu-1.0.0.js"></script>
    <!-- ECharts åœ°å›¾åº“ -->
    <script src="https://cdn.jsdelivr.net/npm/echarts@5.4.3/dist/echarts.min.js"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #f5f5f5;
            min-height: 100vh;
        }
        
        .container {
            max-width: 100%;
            margin: 0 auto;
            background: white;
            min-height: 100vh;
        }
        
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            text-align: center;
        }
        
        .header h1 {
            font-size: 24px;
            margin-bottom: 8px;
            font-weight: 700;
        }
        
        .header p {
            opacity: 0.9;
            font-size: 14px;
        }
        
        /* æ•°æ®å¯¼å…¥ç¡®è®¤æ­¥éª¤ */
        .step-container {
            padding: 30px;
            max-width: 1000px;
            margin: 0 auto;
        }
        
        .step-header {
            text-align: center;
            margin-bottom: 30px;
        }
        
        .step-title {
            font-size: 20px;
            font-weight: 700;
            color: #333;
            margin-bottom: 8px;
        }
        
        .step-description {
            font-size: 14px;
            color: #666;
        }
        
        .data-preview {
            background: #f8f9fa;
            border-radius: 12px;
            padding: 25px;
            margin-bottom: 25px;
        }
        
        .preview-title {
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 15px;
            color: #333;
        }
        
        .data-summary {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-bottom: 25px;
        }
        
        .summary-card {
            background: white;
            border-radius: 8px;
            padding: 15px;
            text-align: center;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        
        .summary-value {
            font-size: 24px;
            font-weight: bold;
            color: #667eea;
            margin-bottom: 5px;
        }
        
        .summary-label {
            font-size: 12px;
            color: #666;
        }
        
        .data-table {
            background: white;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            margin-bottom: 25px;
        }
        
        .table-header {
            background: #667eea;
            color: white;
            padding: 12px 15px;
            font-weight: 600;
            font-size: 14px;
        }
        
        .table-content {
            max-height: 250px;
            overflow-y: auto;
        }
        
        .table-row {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr 2fr;
            gap: 15px;
            padding: 12px 15px;
            border-bottom: 1px solid #eee;
            align-items: center;
            font-size: 14px;
        }
        
        .table-row:hover {
            background: #f8f9fa;
        }
        
        .region-tag {
            display: inline-block;
            padding: 3px 8px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 500;
            color: white;
        }
        
        .action-buttons {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-top: 30px;
        }
        
        .btn {
            padding: 12px 25px;
            border: none;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            min-width: 120px;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.3);
        }
        
        .btn-secondary {
            background: #f8f9fa;
            color: #666;
            border: 2px solid #e9ecef;
        }
        
        .btn-secondary:hover {
            background: #e9ecef;
        }
        
        /* åœ°å›¾å±•ç¤ºåŒºåŸŸ */
        .dashboard-view {
            display: none;
        }
        
        .main-content {
            display: flex;
            min-height: 500px;
        }
        
        .map-section {
            flex: 1;
            padding: 20px;
            background: #f8f9fa;
        }
        
        .map-container {
            background: white;
            border-radius: 12px;
            padding: 15px;
            height: 400px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.08);
        }
        
        .sidebar {
            width: 300px;
            background: white;
            padding: 20px;
            border-left: 1px solid #e9ecef;
            overflow-y: auto;
        }
        
        .legend {
            margin-top: 15px;
            padding: 15px;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        
        .legend-title {
            font-size: 14px;
            font-weight: 600;
            margin-bottom: 12px;
            color: #333;
        }
        
        .legend-items {
            display: grid;
            grid-template-columns: 1fr;
            gap: 8px;
        }
        
        .legend-item {
            display: flex;
            align-items: center;
            font-size: 12px;
            color: #666;
            padding: 6px;
            background: #f8f9fa;
            border-radius: 4px;
        }
        
        .legend-color {
            width: 14px;
            height: 14px;
            border-radius: 3px;
            margin-right: 8px;
        }
        
        .back-button {
            position: fixed;
            top: 15px;
            left: 15px;
            background: rgba(0,0,0,0.7);
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            z-index: 1000;
        }
        
        .back-button:hover {
            background: rgba(0,0,0,0.9);
        }
        
        .loading {
            text-align: center;
            padding: 50px;
            color: #666;
        }
        
        .error {
            text-align: center;
            padding: 50px;
            color: #d32f2f;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ¦ é£ä¹¦é“¶è¡Œæœºæ„åœ°å›¾ä»ªè¡¨ç›˜</h1>
            <p>å¤šç»´è¡¨æ ¼æ•°æ®å¯è§†åŒ–å±•ç¤º</p>
        </div>
        
        <!-- åŠ è½½çŠ¶æ€ -->
        <div id="loadingState" class="loading">
            <div>ğŸ”„ æ­£åœ¨åŠ è½½æ•°æ®...</div>
        </div>
        
        <!-- é”™è¯¯çŠ¶æ€ -->
        <div id="errorState" class="error" style="display: none;">
            <div>âŒ æ•°æ®åŠ è½½å¤±è´¥</div>
            <div id="errorMessage" style="font-size: 14px; margin-top: 10px;"></div>
        </div>
        
        <!-- æ•°æ®ç¡®è®¤æ­¥éª¤ -->
        <div id="dataConfirmStep" class="step-container" style="display: none;">
            <div class="step-header">
                <div class="step-title">ğŸ“Š æ•°æ®é¢„è§ˆä¸ç¡®è®¤</div>
                <div class="step-description">è¯·ç¡®è®¤ä»å¤šç»´è¡¨æ ¼å¯¼å…¥çš„æ•°æ®æ˜¯å¦æ­£ç¡®ï¼Œç„¶åç‚¹å‡»"ç”Ÿæˆåœ°å›¾"æŒ‰é’®</div>
            </div>
            
            <div class="data-preview">
                <div class="preview-title">ğŸ“ˆ æ•°æ®æ¦‚è§ˆ</div>
                <div class="data-summary" id="dataSummary">
                    <!-- åŠ¨æ€ç”Ÿæˆ -->
                </div>
                
                <div class="data-table">
                    <div class="table-header">
                        <div class="table-row">
                            <div>çœä»½</div>
                            <div>åŒºåŸŸ</div>
                            <div>è´Ÿè´£äºº</div>
                            <div>æœºæ„åç§°</div>
                        </div>
                    </div>
                    <div class="table-content" id="dataTableContent">
                        <!-- åŠ¨æ€ç”Ÿæˆ -->
                    </div>
                </div>
            </div>
            
            <div class="action-buttons">
                <button class="btn btn-secondary" onclick="cancelImport()">
                    âŒ å–æ¶ˆå¯¼å…¥
                </button>
                <button class="btn btn-primary" onclick="confirmAndGenerateMap()">
                    âœ… ç¡®è®¤æ•°æ®ï¼Œç”Ÿæˆåœ°å›¾
                </button>
            </div>
        </div>
        
        <!-- åœ°å›¾å±•ç¤ºåŒºåŸŸ -->
        <div id="dashboardView" class="dashboard-view">
            <button class="back-button" onclick="backToDataConfirm()">
                â† è¿”å›æ•°æ®ç¡®è®¤
            </button>
            
            <div class="main-content">
                <div class="map-section">
                    <div class="map-container">
                        <div id="map" style="width: 100%; height: 100%;"></div>
                    </div>
                    
                    <div class="legend">
                        <div class="legend-title">åŒºåŸŸé¢œè‰²å›¾ä¾‹</div>
                        <div class="legend-items" id="legendItems">
                            <!-- åŠ¨æ€ç”Ÿæˆ -->
                        </div>
                    </div>
                </div>
                
                <div class="sidebar">
                    <div id="regionDetails">
                        <!-- åŠ¨æ€ç”Ÿæˆ -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // åŒºåŸŸé¢œè‰²é…ç½® - æŒ‰æœºæ„æ•°é‡æ·±æµ…
        const regionColors = {
            'åä¸œ': { base: '#1976D2', light: '#E3F2FD', medium: '#90CAF9', dark: '#0D47A1' },
            'åå—': { base: '#388E3C', light: '#E8F5E8', medium: '#81C784', dark: '#1B5E20' },
            'ååŒ—': { base: '#F57C00', light: '#FFF3E0', medium: '#FFB74D', dark: '#E65100' },
            'åä¸­': { base: '#7B1FA2', light: '#F3E5F5', medium: '#BA68C8', dark: '#4A148C' },
            'è¥¿å—': { base: '#D32F2F', light: '#FFEBEE', medium: '#E57373', dark: '#B71C1C' },
            'è¥¿åŒ—': { base: '#455A64', light: '#ECEFF1', medium: '#90A4AE', dark: '#263238' },
            'ä¸œåŒ—': { base: '#E64A19', light: '#FBE9E7', medium: '#FF8A65', dark: '#BF360C' },
            'å…¶ä»–': { base: '#9E9E9E', light: '#F5F5F5', medium: '#BDBDBD', dark: '#424242' }
        };
        
        let globalData = null;
        let chart = null;
        
        // é£ä¹¦æ’ä»¶åˆå§‹åŒ–
        window.onFeishuPluginReady = function() {
            console.log('é£ä¹¦æ’ä»¶å·²å‡†å¤‡å°±ç»ª');
            initializePlugin();
        };
        
        // æ’ä»¶é…ç½®æ›´æ–°
        window.onFeishuPluginConfig = function(config) {
            console.log('æ’ä»¶é…ç½®æ›´æ–°:', config);
            if (config && config.bitable) {
                loadBitableData(config.bitable);
            }
        };
        
        // æ’ä»¶ä¿å­˜å›è°ƒ
        window.onFeishuPluginSave = function() {
            console.log('æ’ä»¶ä¿å­˜å›è°ƒ');
            return Promise.resolve({
                success: true,
                data: globalData
            });
        };
        
        // åˆå§‹åŒ–æ’ä»¶
        function initializePlugin() {
            // æ£€æŸ¥æ˜¯å¦åœ¨é£ä¹¦ç¯å¢ƒä¸­
            if (typeof window.FeishuPlugin !== 'undefined') {
                // åœ¨é£ä¹¦ç¯å¢ƒä¸­ï¼Œç­‰å¾…é…ç½®
                console.log('åœ¨é£ä¹¦ç¯å¢ƒä¸­è¿è¡Œ');
            } else {
                // æœ¬åœ°æµ‹è¯•ç¯å¢ƒï¼Œä½¿ç”¨æ¼”ç¤ºæ•°æ®
                console.log('æœ¬åœ°æµ‹è¯•ç¯å¢ƒï¼Œä½¿ç”¨æ¼”ç¤ºæ•°æ®');
                loadDemoData();
            }
        }
        
        // åŠ è½½å¤šç»´è¡¨æ ¼æ•°æ®
        function loadBitableData(bitableConfig) {
            showLoading();
            
            // è¿™é‡Œåº”è¯¥è°ƒç”¨é£ä¹¦APIè·å–å¤šç»´è¡¨æ ¼æ•°æ®
            // ç”±äºæ˜¯åœ¨æ’ä»¶ç¯å¢ƒä¸­ï¼Œä½¿ç”¨é£ä¹¦SDK
            if (window.FeishuPlugin && window.FeishuPlugin.bitable) {
                window.FeishuPlugin.bitable.getRecords({
                    tableId: bitableConfig.tableId
                }).then(records => {
                    const processedData = processRecords(records);
                    showDataConfirmation(processedData);
                }).catch(error => {
                    showError('è·å–å¤šç»´è¡¨æ ¼æ•°æ®å¤±è´¥: ' + error.message);
                });
            } else {
                // é™çº§åˆ°æ¼”ç¤ºæ•°æ®
                loadDemoData();
            }
        }
        
        // åŠ è½½æ¼”ç¤ºæ•°æ®
        function loadDemoData() {
            const demoData = [
                { province: 'æµ™æ±Ÿçœ', region: 'åä¸œ', manager: 'å°æ', organization: 'æµ™å•†é“¶è¡Œ' },
                { province: 'æµ™æ±Ÿçœ', region: 'åä¸œ', manager: 'å°æ', organization: 'æ­å·é“¶è¡Œ' },
                { province: 'å¹¿ä¸œçœ', region: 'åå—', manager: 'å°å¼ ', organization: 'æ·±åœ³é“¶è¡Œ' },
                { province: 'ä¸Šæµ·å¸‚', region: 'åä¸œ', manager: 'å°æ', organization: 'ä¸Šæµ·é“¶è¡Œ' },
                { province: 'å¹¿ä¸œçœ', region: 'åå—', manager: 'å°é™ˆ', organization: 'å¹¿å·é“¶è¡Œ' },
                { province: 'åŒ—äº¬å¸‚', region: 'ååŒ—', manager: 'å°ç‹', organization: 'åŒ—äº¬é“¶è¡Œ' },
                { province: 'æ±Ÿè‹çœ', region: 'åä¸œ', manager: 'å°æ', organization: 'æ±Ÿè‹é“¶è¡Œ' },
                { province: 'å±±ä¸œçœ', region: 'ååŒ—', manager: 'å°ç‹', organization: 'å±±ä¸œé“¶è¡Œ' }
            ];
            
            const processedData = processRawData(demoData);
            showDataConfirmation(processedData);
        }
        
        // å¤„ç†é£ä¹¦è®°å½•æ•°æ®
        function processRecords(records) {
            const rawData = records.map(record => {
                const fields = record.fields;
                let province = fields['æ‰€å±çœä»½'] || '';
                
                // æ ‡å‡†åŒ–çœä»½åç§°
                if (province.includes('æµ™æ±Ÿ')) province = 'æµ™æ±Ÿçœ';
                else if (province.includes('å¹¿ä¸œ')) province = 'å¹¿ä¸œçœ';
                else if (province.includes('ä¸Šæµ·')) province = 'ä¸Šæµ·å¸‚';
                else if (province.includes('åŒ—äº¬')) province = 'åŒ—äº¬å¸‚';
                else if (province.includes('æ±Ÿè‹')) province = 'æ±Ÿè‹çœ';
                else if (province.includes('å±±ä¸œ')) province = 'å±±ä¸œçœ';
                
                return {
                    province: province,
                    region: fields['ç®¡ç†åŒºåŸŸ'] || 'å…¶ä»–',
                    manager: fields['è´Ÿè´£äºº'] || 'æœªçŸ¥',
                    organization: fields['æœºæ„åç§°'] || 'æœªçŸ¥'
                };
            }).filter(item => item.province && item.organization);
            
            return processRawData(rawData);
        }
        
        // å¤„ç†åŸå§‹æ•°æ®
        function processRawData(rawData) {
            // æŒ‰çœä»½èšåˆæ•°æ®
            const provinceData = {};
            rawData.forEach(item => {
                if (!provinceData[item.province]) {
                    provinceData[item.province] = {
                        province: item.province,
                        region: item.region,
                        institutionCount: 0,
                        managers: new Set(),
                        organizations: []
                    };
                }
                provinceData[item.province].institutionCount += 1;
                provinceData[item.province].managers.add(item.manager);
                provinceData[item.province].organizations.push(item.organization);
            });
            
            // è½¬æ¢ä¸ºæœ€ç»ˆæ ¼å¼
            const mapData = Object.values(provinceData).map(item => ({
                name: item.province,
                value: item.institutionCount,
                region: item.region,
                institutionCount: item.institutionCount,
                managers: Array.from(item.managers),
                organizations: item.organizations
            }));
            
            // ç»Ÿè®¡åŒºåŸŸä¿¡æ¯å¹¶è®¡ç®—é¢œè‰²æ·±æµ…
            const regionStats = {};
            mapData.forEach(item => {
                if (!regionStats[item.region]) {
                    regionStats[item.region] = {
                        provinces: [],
                        totalInstitutions: 0,
                        managers: new Set(),
                        maxInstitutions: 0
                    };
                }
                regionStats[item.region].provinces.push(item.name);
                regionStats[item.region].totalInstitutions += item.institutionCount;
                regionStats[item.region].maxInstitutions = Math.max(regionStats[item.region].maxInstitutions, item.institutionCount);
                item.managers.forEach(manager => regionStats[item.region].managers.add(manager));
            });
            
            // ä¸ºæ¯ä¸ªçœä»½è®¾ç½®é¢œè‰²ï¼ˆåŸºäºè¯¥åŒºåŸŸå†…æœºæ„æ•°é‡çš„ç›¸å¯¹å¯†åº¦ï¼‰
            mapData.forEach(item => {
                const regionStat = regionStats[item.region];
                const colorConfig = regionColors[item.region] || regionColors['å…¶ä»–'];
                
                // æ ¹æ®æœºæ„æ•°é‡è®¡ç®—é¢œè‰²æ·±æµ…
                let color;
                if (item.institutionCount >= 3) {
                    color = colorConfig.dark;  // æ·±è‰²
                } else if (item.institutionCount >= 2) {
                    color = colorConfig.base;  // åŸºç¡€è‰²
                } else {
                    color = colorConfig.light; // æµ…è‰²
                }
                
                item.itemStyle = { areaColor: color };
            });
            
            return { mapData, regionStats, rawData };
        }
        
        // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
        function showLoading() {
            document.getElementById('loadingState').style.display = 'block';
            document.getElementById('errorState').style.display = 'none';
            document.getElementById('dataConfirmStep').style.display = 'none';
            document.getElementById('dashboardView').style.display = 'none';
        }
        
        // æ˜¾ç¤ºé”™è¯¯çŠ¶æ€
        function showError(message) {
            document.getElementById('loadingState').style.display = 'none';
            document.getElementById('errorState').style.display = 'block';
            document.getElementById('errorMessage').textContent = message;
            document.getElementById('dataConfirmStep').style.display = 'none';
            document.getElementById('dashboardView').style.display = 'none';
        }
        
        // æ˜¾ç¤ºæ•°æ®ç¡®è®¤
        function showDataConfirmation(data) {
            globalData = data;
            const { mapData, regionStats, rawData } = data;
            
            document.getElementById('loadingState').style.display = 'none';
            document.getElementById('errorState').style.display = 'none';
            document.getElementById('dataConfirmStep').style.display = 'block';
            document.getElementById('dashboardView').style.display = 'none';
            
            // ç”Ÿæˆæ•°æ®æ¦‚è§ˆ
            const summaryHTML = \`
                <div class="summary-card">
                    <div class="summary-value">\${rawData.length}</div>
                    <div class="summary-label">æ€»æœºæ„æ•°</div>
                </div>
                <div class="summary-card">
                    <div class="summary-value">\${mapData.length}</div>
                    <div class="summary-label">è¦†ç›–çœä»½</div>
                </div>
                <div class="summary-card">
                    <div class="summary-value">\${Object.keys(regionStats).length}</div>
                    <div class="summary-label">è¦†ç›–åŒºåŸŸ</div>
                </div>
                <div class="summary-card">
                    <div class="summary-value">\${[...new Set(rawData.map(d => d.manager))].length}</div>
                    <div class="summary-label">è´Ÿè´£äººæ•°</div>
                </div>
            \`;
            document.getElementById('dataSummary').innerHTML = summaryHTML;
            
            // ç”Ÿæˆæ•°æ®è¡¨æ ¼
            const tableHTML = rawData.slice(0, 10).map(item => \`
                <div class="table-row">
                    <div>\${item.province}</div>
                    <div>
                        <span class="region-tag" style="background: \${(regionColors[item.region] || regionColors['å…¶ä»–']).base};">
                            \${item.region}
                        </span>
                    </div>
                    <div>\${item.manager}</div>
                    <div>\${item.organization}</div>
                </div>
            \`).join('') + (rawData.length > 10 ? \`
                <div class="table-row" style="text-align: center; color: #666; font-style: italic;">
                    <div style="grid-column: 1 / -1;">... è¿˜æœ‰ \${rawData.length - 10} æ¡è®°å½•</div>
                </div>
            \` : '');
            document.getElementById('dataTableContent').innerHTML = tableHTML;
        }
        
        // å–æ¶ˆå¯¼å…¥
        function cancelImport() {
            if (confirm('ç¡®å®šè¦å–æ¶ˆå¯¼å…¥å—ï¼Ÿ')) {
                if (window.FeishuPlugin) {
                    window.FeishuPlugin.close();
                } else {
                    alert('å·²å–æ¶ˆå¯¼å…¥');
                }
            }
        }
        
        // ç¡®è®¤å¹¶ç”Ÿæˆåœ°å›¾
        function confirmAndGenerateMap() {
            document.getElementById('dataConfirmStep').style.display = 'none';
            document.getElementById('dashboardView').style.display = 'block';
            
            // å»¶è¿Ÿåˆå§‹åŒ–åœ°å›¾ï¼Œç¡®ä¿DOMå·²æ¸²æŸ“
            setTimeout(() => {
                initializeMap();
                generateSidebar();
                generateLegend();
            }, 100);
        }
        
        // è¿”å›æ•°æ®ç¡®è®¤
        function backToDataConfirm() {
            document.getElementById('dashboardView').style.display = 'none';
            document.getElementById('dataConfirmStep').style.display = 'block';
            
            // é”€æ¯åœ°å›¾å®ä¾‹
            if (chart) {
                chart.dispose();
                chart = null;
            }
        }
        
        // åˆå§‹åŒ–åœ°å›¾
        function initializeMap() {
            if (!globalData) return;
            
            if (chart) {
                chart.dispose();
            }
            
            chart = echarts.init(document.getElementById('map'));
            
            // è·å–ä¸­å›½åœ°å›¾æ•°æ®
            fetch('https://geo.datav.aliyun.com/areas_v3/bound/100000_full.json')
                .then(response => response.json())
                .then(geoJson => {
                    echarts.registerMap('china', geoJson);
                    
                    const option = {
                        title: {
                            text: 'é“¶è¡Œæœºæ„åŒºåŸŸåˆ†å¸ƒå›¾',
                            left: 'center',
                            top: 15,
                            textStyle: {
                                color: '#333',
                                fontSize: 16,
                                fontWeight: 'bold'
                            }
                        },
                        tooltip: {
                            trigger: 'item',
                            backgroundColor: 'rgba(0,0,0,0.85)',
                            borderColor: 'transparent',
                            borderRadius: 6,
                            textStyle: {
                                color: '#fff',
                                fontSize: 12
                            },
                            formatter: function(params) {
                                if (params.data) {
                                    const data = params.data;
                                    return \`
                                        <div style="padding: 12px; max-width: 250px;">
                                            <div style="font-weight: bold; margin-bottom: 8px; font-size: 14px;">
                                                ğŸ›ï¸ \${data.name}
                                            </div>
                                            <div style="margin-bottom: 6px;">
                                                ğŸŒ æ‰€å±åŒºåŸŸ: <span style="color: \${(regionColors[data.region] || regionColors['å…¶ä»–']).base};">\${data.region}</span>
                                            </div>
                                            <div style="margin-bottom: 6px;">
                                                ğŸ¦ æœºæ„æ•°é‡: <span style="color: #64B5F6;">\${data.institutionCount}å®¶</span>
                                            </div>
                                            <div style="margin-bottom: 6px;">
                                                ğŸ‘¥ è´Ÿè´£äºº: <span style="color: #81C784;">\${data.managers.join(', ')}</span>
                                            </div>
                                            <div style="margin-bottom: 3px; font-weight: 600;">æœºæ„åˆ—è¡¨:</div>
                                            <div style="font-size: 11px; color: #E0E0E0;">
                                                \${data.organizations.join(' â€¢ ')}
                                            </div>
                                        </div>
                                    \`;
                                }
                                return \`<div style="padding: 8px;">\${params.name}<br/>æš‚æ— æ•°æ®</div>\`;
                            }
                        },
                        series: [{
                            name: 'é“¶è¡Œæœºæ„',
                            type: 'map',
                            map: 'china',
                            roam: true,
                            emphasis: {
                                label: {
                                    show: true,
                                    color: '#fff',
                                    fontSize: 11,
                                    fontWeight: 'bold'
                                },
                                itemStyle: {
                                    shadowBlur: 15,
                                    shadowColor: 'rgba(0,0,0,0.3)'
                                }
                            },
                            itemStyle: {
                                borderColor: '#fff',
                                borderWidth: 1,
                                shadowBlur: 3,
                                shadowColor: 'rgba(0,0,0,0.1)',
                                areaColor: '#f0f0f0'
                            },
                            data: globalData.mapData
                        }]
                    };
                    
                    chart.setOption(option);
                    
                    // å“åº”å¼
                    window.addEventListener('resize', () => {
                        if (chart) {
                            chart.resize();
                        }
                    });
                })
                .catch(error => {
                    console.error('åœ°å›¾åŠ è½½å¤±è´¥:', error);
                    document.getElementById('map').innerHTML = \`
                        <div style="display: flex; align-items: center; justify-content: center; height: 100%; color: #666; font-size: 14px;">
                            <div style="text-align: center;">
                                <div style="font-size: 40px; margin-bottom: 12px;">ğŸ¦</div>
                                <div>åœ°å›¾åŠ è½½å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥</div>
                            </div>
                        </div>
                    \`;
                });
        }
        
        // ç”Ÿæˆä¾§è¾¹æ 
        function generateSidebar() {
            if (!globalData) return;
            
            const { regionStats } = globalData;
            const sidebarHTML = \`
                <div style="margin-bottom: 25px;">
                    <h3 style="margin-bottom: 15px; color: #333; font-size: 16px;">ğŸŒ åŒºåŸŸåˆ†å¸ƒè¯¦æƒ…</h3>
                    \${Object.keys(regionStats).map(region => {
                        const stats = regionStats[region];
                        const colorConfig = regionColors[region] || regionColors['å…¶ä»–'];
                        return \`
                            <div style="background: #f8f9fa; border-radius: 8px; padding: 12px; margin-bottom: 12px;">
                                <div style="display: flex; align-items: center; margin-bottom: 8px;">
                                    <span style="width: 10px; height: 10px; border-radius: 50%; background: \${colorConfig.base}; margin-right: 6px;"></span>
                                    <strong style="font-size: 14px;">\${region}</strong>
                                    <span style="margin-left: auto; color: #666; font-size: 12px;">\${stats.totalInstitutions}å®¶æœºæ„</span>
                                </div>
                                <div style="font-size: 12px; color: #666; line-height: 1.4;">
                                    <div>çœä»½: \${stats.provinces.join(', ')}</div>
                                    <div>è´Ÿè´£äºº: \${Array.from(stats.managers).join(', ')}</div>
                                </div>
                            </div>
                        \`;
                    }).join('')}
                </div>
            \`;
            document.getElementById('regionDetails').innerHTML = sidebarHTML;
        }
        
        // ç”Ÿæˆå›¾ä¾‹
        function generateLegend() {
            if (!globalData) return;
            
            const { regionStats } = globalData;
            const legendHTML = Object.keys(regionStats).map(region => {
                const stats = regionStats[region];
                const colorConfig = regionColors[region] || regionColors['å…¶ä»–'];
                return \`
                    <div class="legend-item">
                        <span class="legend-color" style="background: \${colorConfig.base};"></span>
                        <span>\${region} (\${stats.provinces.length}çœ, \${stats.totalInstitutions}æœºæ„)</span>
                    </div>
                \`;
            }).join('');
            document.getElementById('legendItems').innerHTML = legendHTML;
        }
        
        // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            // å¦‚æœä¸åœ¨é£ä¹¦ç¯å¢ƒä¸­ï¼Œç›´æ¥åˆå§‹åŒ–
            if (typeof window.FeishuPlugin === 'undefined') {
                initializePlugin();
            }
        });
    </script>
</body>
</html>